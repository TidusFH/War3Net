# Warcraft 3 v1.27 Trigger File Format (.wtg)

## Overview
This document details the WC3 1.27 format for trigger files based on research conducted while debugging WTGMerger.

## File Format Details

### Format Detection
- **1.27 Format Detection**: `triggers.SubVersion == null`
- **Newer Formats**: `triggers.SubVersion != null` (e.g., Reforged)

### File Structure (1.27)

The .wtg file has a specific structure:

```
[Header]
[Format Version]
[All Categories]        ← Read sequentially
[Game Version]
[All Variables]         ← Read sequentially
[All Triggers]          ← Read sequentially
```

**CRITICAL**: In 1.27 format, categories and triggers CANNOT be interspersed. All categories must be written before all triggers.

## What Gets Saved and What Doesn't

### Category Data

| Field | Saved in 1.27? | Read from File? | Notes |
|-------|----------------|-----------------|-------|
| **Id** | ✅ YES | ✅ YES | Can be non-sequential! (0,1,2,4,3,6,8,25...) |
| **Name** | ✅ YES | ✅ YES | Category name string |
| **IsComment** | ✅ YES | ✅ YES | Visual separator flag |
| **ParentId** | ❌ NO | ❌ NO | NOT saved in 1.27, defaults to 0 |
| **IsExpanded** | ❌ NO | ❌ NO | NOT saved in 1.27 |

### Trigger Data

| Field | Saved in 1.27? | Read from File? | Notes |
|-------|----------------|-----------------|-------|
| **Id** | ❌ NO | ❌ NO | NOT saved, all default to 0 |
| **Name** | ✅ YES | ✅ YES | Trigger name string |
| **ParentId** | ✅ YES | ✅ YES | Points to category ID |
| **IsEnabled** | ✅ YES | ✅ YES | |
| **IsCustomTextTrigger** | ✅ YES | ✅ YES | |
| **IsInitiallyOn** | ✅ YES | ✅ YES | |
| **RunOnMapInit** | ✅ YES | ✅ YES | |
| **Description** | ✅ YES | ✅ YES | |
| **Functions** | ✅ YES | ✅ YES | Trigger actions/events/conditions |

## Critical Insights

### 1. Non-Sequential Category IDs Work Perfectly

**Discovery**: Maps created in World Editor have non-sequential category IDs (e.g., 0, 1, 2, 4, 3, 6, 8, 25, 27...)

**Evidence**:
- Original TARGET.wtg had non-sequential category IDs
- When loaded as Source file, displayed correctly with those IDs
- World Editor opens and displays it correctly
- BetterTriggers parses it correctly

**Conclusion**: Category IDs do NOT need to be sequential. War3Net reads/writes them directly from/to file.

### 2. Duplicate Trigger IDs Are Normal

**For 1.27 Format**:
- Trigger IDs are NOT stored in file
- War3Net loads all triggers with `Id = 0` by default
- This creates duplicate IDs, which is **completely normal**
- War3Net's internal logic handles this correctly

**DO NOT** try to "fix" duplicate trigger IDs - it's not broken!

### 3. ParentId Relationships

**How Categories Are Displayed**:

For **1.27 format**, World Editor uses **file order** to determine visual hierarchy:
- Categories appear in the order they're stored in file
- Triggers appear under the category whose ID matches their ParentId
- Category ParentIds are ignored (not saved/read)

**Critical Rule**: `trigger.ParentId` must match `category.Id` exactly.

**Example**:
```
Category "Obelisks Arthas" - ID: 17
  ↓ (file order shows visual nesting)
Trigger "Combat Detected" - ParentId: 17 ✓ Matches!
Trigger "Combat Resolved" - ParentId: 17 ✓ Matches!
```

### 4. Comment Categories

**What They Are**:
- Visual separators in World Editor's trigger list
- Have `IsComment = true`
- Should NOT contain triggers

**Issue**: Sometimes triggers have `ParentId` pointing to comment categories.

**Fix**: Use FixTriggersInCommentCategories to reassign them to a non-comment category.

## War3Net Reading Process (1.27)

Based on `src/War3Net.Build.Core/Serialization/Binary/Script/MapTriggers.cs`:

```csharp
// Read header and version
var version = reader.ReadInt32();

// Read all categories
nint triggerCategoryDefinitionCount = reader.ReadInt32();
for (nint i = 0; i < triggerCategoryDefinitionCount; i++)
{
    TriggerItems.Add(reader.ReadTriggerCategoryDefinition(...));
    // Category.Id is read from file (line 24 of TriggerCategoryDefinition.cs)
    // Category.ParentId is NOT read - not in 1.27 format
}

// Read game version
GameVersion = reader.ReadInt32();

// Read all variables
nint variableDefinitionCount = reader.ReadInt32();
for (nint i = 0; i < variableDefinitionCount; i++)
{
    Variables.Add(reader.ReadVariableDefinition(...));
}

// Read all triggers
nint triggerDefinitionCount = reader.ReadInt32();
for (nint i = 0; i < triggerDefinitionCount; i++)
{
    TriggerItems.Add(reader.ReadTriggerDefinition(...));
    // Trigger.Id is NOT read - not in 1.27 format (defaults to 0)
    // Trigger.ParentId IS read from file (line 41 of TriggerDefinition.cs)
}
```

## War3Net Writing Process (1.27)

```csharp
writer.Write(FileFormatSignature);
writer.Write((int)FormatVersion);

// Write all categories (excluding RootCategory)
var triggerCategories = TriggerItems
    .Where(item => item is TriggerCategoryDefinition && item.Type != TriggerItemType.RootCategory)
    .ToArray();
writer.Write(triggerCategories.Length);
foreach (var triggerCategory in triggerCategories)
{
    writer.Write(triggerCategory, ...);
    // Writes: Id, Name, IsComment
    // Does NOT write: ParentId, IsExpanded
}

writer.Write(GameVersion);

// Write all variables
writer.Write(Variables.Count);
foreach (var variable in Variables)
{
    writer.Write(variable, ...);
}

// Write all triggers
var triggers = TriggerItems.Where(item => item is TriggerDefinition).ToArray();
writer.Write(triggers.Length);
foreach (var trigger in triggers)
{
    writer.Write(trigger, ...);
    // Writes: Name, Description, IsComment, IsEnabled, IsCustomTextTrigger,
    //         IsInitiallyOn, RunOnMapInit, ParentId, Functions
    // Does NOT write: Id
}
```

## Common Pitfalls to Avoid

### ❌ DON'T: Renumber Category IDs
```csharp
// BAD - breaks ParentId relationships
for (int i = 0; i < categories.Count; i++)
{
    categories[i].Id = i; // This changes the ID!
    // Now trigger.ParentId doesn't match anymore!
}
```

### ✅ DO: Preserve Original IDs
```csharp
// GOOD - keep original non-sequential IDs
// They work perfectly fine!
// Just reorder items if needed (categories before triggers)
```

### ❌ DON'T: Try to Fix Duplicate Trigger IDs
```csharp
// BAD - duplicate trigger IDs are normal in 1.27!
FixDuplicateIds(triggers); // Don't do this!
```

### ✅ DO: Leave Trigger IDs Alone
```csharp
// GOOD - War3Net handles duplicate trigger IDs correctly
// They all have Id=0 and that's fine!
```

### ❌ DON'T: Recalculate ParentIds
```csharp
// BAD - ParentIds from file are already correct!
trigger.ParentId = categories.IndexOf(parentCategory);
```

### ✅ DO: Preserve ParentIds from File
```csharp
// GOOD - ParentIds already match category IDs correctly
// Just leave them unchanged!
```

## Summary of Key Rules

1. **Category IDs can be non-sequential** - don't renumber them!
2. **Trigger IDs are all 0** - this is normal, don't fix it!
3. **ParentIds from file are correct** - preserve them exactly!
4. **File order matters** - categories must come before triggers in TriggerItems list
5. **Category ParentIds don't matter in 1.27** - they're not saved/read
6. **Trigger ParentIds are critical** - they must match category IDs exactly

## References

- War3Net Source: `/src/War3Net.Build.Core/Serialization/Binary/Script/`
- HiveWE Wiki: https://github.com/stijnherfst/HiveWE/wiki/war3map.wtg-Triggers
- WC3C Specs: http://www.wc3c.net/tools/specs/index.html
